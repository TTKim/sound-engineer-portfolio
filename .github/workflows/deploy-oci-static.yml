name: Deploy Static Site to OCI

on:
  push:
    branches: ["main"]
    paths:
      - "index.html"
      - "styles.css"
      - "script.js"
      - "Portfolio_list.csv"
      - "portfolio_media_map.json"
      - ".github/workflows/deploy-oci-static.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OCI CLI
        run: |
          python -m pip install --upgrade pip
          pip install oci-cli

      - name: Configure OCI CLI
        shell: bash
        run: |
          mkdir -p "$HOME/.oci"
          cat > "$HOME/.oci/config" <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=ca-montreal-1
          key_file=$HOME/.oci/oci_api_key.pem
          pass_phrase=${{ secrets.OCI_CLI_PASSPHRASE }}
          EOF
          cat > "$HOME/.oci/oci_api_key.pem" <<'EOF'
          ${{ secrets.OCI_PRIVATE_KEY_PEM }}
          EOF
          chmod 600 "$HOME/.oci/config" "$HOME/.oci/oci_api_key.pem"

      - name: Build deploy-ready index with cache-busting version
        shell: bash
        run: |
          BUILD_ID="${GITHUB_SHA::8}"
          sed "s/__BUILD_ID__/${BUILD_ID}/g" index.html > index.deploy.html

      - name: Upload files to OCI bucket
        shell: bash
        env:
          OCI_CLI_PROFILE: DEFAULT
        run: |
          oci os object put --force \
            --namespace-name axqgdd9bzhff \
            --bucket-name bigsummer-portfolio \
            --name index.html \
            --file index.deploy.html \
            --content-type text/html \
            --cache-control "no-cache, no-store, must-revalidate" \
            --region ca-montreal-1
          oci os object put --force \
            --namespace-name axqgdd9bzhff \
            --bucket-name bigsummer-portfolio \
            --name styles.css \
            --file styles.css \
            --content-type text/css \
            --cache-control "public, max-age=300, must-revalidate" \
            --region ca-montreal-1
          oci os object put --force \
            --namespace-name axqgdd9bzhff \
            --bucket-name bigsummer-portfolio \
            --name script.js \
            --file script.js \
            --content-type application/javascript \
            --cache-control "public, max-age=300, must-revalidate" \
            --region ca-montreal-1
          oci os object put --force \
            --namespace-name axqgdd9bzhff \
            --bucket-name bigsummer-portfolio \
            --name Portfolio_list.csv \
            --file Portfolio_list.csv \
            --content-type text/csv \
            --cache-control "public, max-age=300, must-revalidate" \
            --region ca-montreal-1
          oci os object put --force \
            --namespace-name axqgdd9bzhff \
            --bucket-name bigsummer-portfolio \
            --name portfolio_media_map.json \
            --file portfolio_media_map.json \
            --content-type application/json \
            --cache-control "public, max-age=300, must-revalidate" \
            --region ca-montreal-1

      - name: Purge Cloudflare cache for portfolio host (optional)
        shell: bash
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [[ -n "${CLOUDFLARE_API_TOKEN}" && -n "${CLOUDFLARE_ZONE_ID}" ]]; then
            curl -sS -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"hosts":["portfolio.hajungs.com"]}'
          else
            echo "Cloudflare purge skipped (secrets not set)."
          fi
